@override
  Widget build(BuildContext context) {
    return InheritedUser(
      user: widget.user,
      child: InheritedRoom(
        room: widget.room,
        child: InheritedChatTheme(
          theme: widget.theme,
          child: InheritedL10n(
            l10n: widget.l10n,
            child: Stack(
              children: [
                Container(
                  color: widget.theme.backgroundColor,
                  child: Column(
                    children: [
                      Flexible(
                        child: widget.messages.isEmpty
                            ? SizedBox.expand(
                                child: _emptyStateBuilder(),
                              )
                            : GestureDetector(
                                onTap: () {
                                  FocusManager.instance.primaryFocus?.unfocus();
                                  widget.onBackgroundTap?.call();
                                },
                                child: LayoutBuilder(
                                  builder: (BuildContext context,
                                          BoxConstraints constraints) =>
                                      ChatList(
                                    isLastPage: widget.isLastPage,
                                    itemBuilder: (item, index) =>
                                        _messageBuilder(item, constraints),
                                    items: _chatMessages,
                                    onEndReached: widget.onEndReached,
                                    onEndReachedThreshold:
                                        widget.onEndReachedThreshold,
                                    scrollPhysics: widget.scrollPhysics,
                                  ),
                                ),
                              ),
                      ),
                      widget.customBottomWidget ??
                          Input(
                            isAttachmentUploading: widget.isAttachmentUploading,
                            onAttachmentPressed: widget.onAttachmentPressed,
                            onSendPressed: widget.onSendPressed,
                            onTextChanged: widget.onTextChanged,
                            onTextFieldTap: widget.onTextFieldTap,
                            sendButtonVisibilityMode:
                                widget.sendButtonVisibilityMode,
                          ),
                    ],
                  ),
                ),
                if (_isImageViewVisible) _imageGalleryBuilder(),
              ],
            ),
          ),
        ),
      ),
    );
  }